<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Referral Lookup - West Salem</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #f5f5f5;
    }
    
    h1 {
      color: #333;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .search-container {
      position: relative;
    }
    
    #searchInput {
      width: 100%;
      padding: 16px 20px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    #searchInput:focus {
      border-color: #007bff;
    }
    
    #results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
    }
    
    #results.show {
      display: block;
    }
    
    .result-item {
      padding: 16px 20px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background 0.15s;
    }
    
    .result-item:hover {
      background: #f0f7ff;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    .result-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .result-details {
      font-size: 14px;
      color: #666;
    }
    
    .result-details span {
      margin-right: 16px;
    }
    
    .no-results {
      padding: 20px;
      text-align: center;
      color: #666;
    }
    
    .loading {
      padding: 20px;
      text-align: center;
      color: #666;
    }
    
    .instructions {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      color: #666;
      font-size: 14px;
    }
    
    .instructions h3 {
      color: #333;
      margin-top: 0;
    }
    
    .selected-member {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 2px solid #007bff;
    }
    
    .selected-member h3 {
      color: #333;
      margin-top: 0;
      margin-bottom: 15px;
    }
    
    .member-info {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .member-info p {
      margin: 5px 0;
      color: #333;
    }
    
    .member-info .name {
      font-weight: 600;
      font-size: 18px;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-secondary {
      background: #28a745;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #1e7e34;
    }
    
    .btn-outline {
      background: white;
      color: #666;
      border: 2px solid #ddd;
    }
    
    .btn-outline:hover {
      border-color: #007bff;
      color: #007bff;
    }
    
    .manual-entry {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Member Referral Lookup</h1>
  <p class="subtitle">West Salem Location</p>
  
  <div class="search-container">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search by name, email, or phone..."
      autocomplete="off"
    >
    <div id="results"></div>
  </div>
  
  <div id="selectedMember" class="selected-member" style="display: none;">
    <h3>Selected Member</h3>
    <div id="memberInfo" class="member-info"></div>
    <div class="action-buttons">
      <button class="btn btn-primary" onclick="openReferralForm()">
        üìã Referral Form
      </button>
      <button class="btn btn-secondary" onclick="openDayOneForm()">
        üìÖ Book Day One
      </button>
    </div>
  </div>

  <div class="manual-entry">
    <button class="btn btn-outline" onclick="openManualEntry()">
      ‚úèÔ∏è Manual Entry (Member not in system)
    </button>
  </div>

  <div class="instructions">
    <h3>How to use</h3>
    <p>1. Start typing a member's name, email, or phone number</p>
    <p>2. Click on the member from the results</p>
    <p>3. Choose to open the Referral Form or Book Day One</p>
    <p>4. Use Manual Entry if the member isn't in the system yet</p>
  </div>

  <script>
    let formUrl = '';
    let dayOneFormUrl = ''; // Will be configured later
    let manualEntryUrl = ''; // Will be configured later
    let selectedContact = null;
    let debounceTimer;
    
    // Get config on load
    fetch('/api/config')
      .then(res => res.json())
      .then(config => {
        formUrl = config.formUrl;
        dayOneFormUrl = config.dayOneFormUrl || '';
        manualEntryUrl = config.manualEntryUrl || '';
      });
    
    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const selectedMemberDiv = document.getElementById('selectedMember');
    const memberInfoDiv = document.getElementById('memberInfo');
    
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      
      // Clear previous timer
      clearTimeout(debounceTimer);
      
      // Hide selected member when searching again
      selectedMemberDiv.style.display = 'none';
      
      if (query.length < 2) {
        resultsDiv.classList.remove('show');
        return;
      }
      
      // Show loading
      resultsDiv.innerHTML = '<div class="loading">Searching...</div>';
      resultsDiv.classList.add('show');
      
      // Debounce the search
      debounceTimer = setTimeout(() => {
        searchContacts(query);
      }, 300);
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        resultsDiv.classList.remove('show');
      }
    });
    
    // Show results when focusing input (if there's text)
    searchInput.addEventListener('focus', () => {
      if (searchInput.value.trim().length >= 2 && resultsDiv.innerHTML) {
        resultsDiv.classList.add('show');
      }
    });
    
    async function searchContacts(query) {
      try {
        const response = await fetch(`/api/search?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.contacts && data.contacts.length > 0) {
          resultsDiv.innerHTML = data.contacts.map(contact => `
            <div class="result-item" onclick='selectContact(${JSON.stringify(contact)})'>
              <div class="result-name">${escapeHtml(contact.name) || 'No Name'}</div>
              <div class="result-details">
                ${contact.email ? `<span>üìß ${escapeHtml(contact.email)}</span>` : ''}
                ${contact.phone ? `<span>üì± ${escapeHtml(contact.phone)}</span>` : ''}
              </div>
            </div>
          `).join('');
        } else {
          resultsDiv.innerHTML = '<div class="no-results">No members found</div>';
        }
        
        resultsDiv.classList.add('show');
      } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = '<div class="no-results">Search failed. Please try again.</div>';
      }
    }
    
    function selectContact(contact) {
      selectedContact = contact;
      
      // Update the member info display
      memberInfoDiv.innerHTML = `
        <p class="name">${escapeHtml(contact.name) || 'No Name'}</p>
        ${contact.email ? `<p>üìß ${escapeHtml(contact.email)}</p>` : ''}
        ${contact.phone ? `<p>üì± ${escapeHtml(contact.phone)}</p>` : ''}
      `;
      
      // Show the selected member section
      selectedMemberDiv.style.display = 'block';
      
      // Clear search and hide results
      searchInput.value = '';
      resultsDiv.classList.remove('show');
    }
    
    function buildFormUrl(baseUrl, contact) {
      if (!baseUrl) {
        alert('Form URL not configured');
        return null;
      }
      
      const params = new URLSearchParams();
      if (contact.firstName) params.set('first_name', contact.firstName);
      if (contact.lastName) params.set('last_name', contact.lastName);
      if (contact.email) params.set('email', contact.email);
      if (contact.phone) params.set('phone', contact.phone);
      
      return `${baseUrl}?${params.toString()}`;
    }
    
    function openReferralForm() {
      if (!selectedContact) return;
      const url = buildFormUrl(formUrl, selectedContact);
      if (url) window.open(url, '_blank');
    }
    
    function openDayOneForm() {
      if (!selectedContact) return;
      if (!dayOneFormUrl) {
        alert('Day One form URL not configured yet');
        return;
      }
      const url = buildFormUrl(dayOneFormUrl, selectedContact);
      if (url) window.open(url, '_blank');
    }
    
    function openManualEntry() {
      if (!manualEntryUrl) {
        alert('Manual entry form URL not configured yet');
        return;
      }
      window.open(manualEntryUrl, '_blank');
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
